<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¨åˆ©çš„æˆ˜åˆ©å“</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .emoji-card:hover .overlay {
            opacity: 1;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-6 animate-fade-in-up">
            <div class="glass rounded-2xl shadow-2xl p-4 md:p-6 border border-white/20">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl md:text-4xl">ğŸ†</span>
                        <div>
                            <h1 class="text-xl md:text-3xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                äº¨åˆ©çš„æˆ˜åˆ©å“
                            </h1>
                            <p class="text-gray-500 text-xs md:text-sm">ç²¾å¿ƒæ”¶è—çš„è¡¨æƒ…åŒ…å®åº“</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-purple-50 px-3 py-2 rounded-xl">
                        <span class="text-2xl md:text-3xl font-bold text-purple-600">{{ stats.total_images }}</span>
                        <span class="text-xs text-gray-500 uppercase tracking-wide">æ€»æ”¶è—</span>
                    </div>
                </div>
                
                <!-- Categories Stats -->
                <div class="flex flex-wrap gap-1.5">
                    <div v-for="(count, cat) in stats.categories" :key="cat" 
                         class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 border border-purple-200 hover:shadow-md transition">
                        <span class="text-xs font-medium text-purple-700">{{ cat }}</span>
                        <span class="text-xs font-bold text-purple-900 bg-white/60 px-1.5 py-0.5 rounded-full">{{ count }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Controls -->
        <div class="glass p-4 md:p-5 rounded-2xl shadow-xl mb-6 sticky top-4 z-20 border border-white/20 animate-fade-in-up">
            <div class="flex flex-col sm:flex-row gap-3">
                <!-- Search -->
                <div class="flex-1 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <input type="text" v-model="searchQuery" @input="debouncedSearch"
                           placeholder="æœç´¢è¡¨æƒ…åŒ…..." 
                           class="w-full pl-10 pr-3 py-2.5 md:py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition bg-white/80 text-sm">
                </div>
                <!-- Category Filter -->
                <select v-model="selectedCategory" @change="fetchImages(1)"
                        class="px-3 py-2.5 md:py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none bg-white/80 cursor-pointer transition text-sm">
                    <option value="">ğŸ“‚ å…¨éƒ¨åˆ†ç±»</option>
                    <option v-for="(count, cat) in stats.categories" :key="cat" :value="cat">
                        {{ cat }} ({{ count }})
                    </option>
                </select>
            </div>
            
            <!-- Action Buttons - stacked on mobile -->
            <div class="flex flex-wrap gap-2 mt-3">
                <button @click="openUploadModal" 
                        class="flex-1 sm:flex-none px-4 py-2.5 md:py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-lg hover:shadow-xl font-medium text-sm md:text-base flex items-center justify-center gap-1.5">
                    <span>â•</span>
                    <span class="hidden xs:inline">æ·»åŠ è¡¨æƒ…åŒ…</span>
                    <span class="xs:hidden">æ·»åŠ </span>
                </button>
                <button @click="openEmotionsModal" 
                        class="flex-1 sm:flex-none px-4 py-2.5 md:py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 transition shadow-lg hover:shadow-xl font-medium text-sm md:text-base flex items-center justify-center gap-1.5">
                    <span>ğŸ˜Š</span>
                    <span class="hidden xs:inline">æƒ…ç»ªåˆ†ç±»</span>
                    <span class="xs:hidden">åˆ†ç±»</span>
                </button>
                <button @click="fetchImages(1)" 
                        class="flex-1 sm:flex-none px-4 py-2.5 md:py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition shadow-lg hover:shadow-xl font-medium text-sm md:text-base flex items-center justify-center gap-1.5">
                    <span>ğŸ”„</span>
                    <span class="hidden xs:inline">åˆ·æ–°</span>
                </button>
            </div>
        </div>

        <!-- Gallery -->
        <div v-if="loading" class="text-center py-16">
            <div class="inline-block">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-200 border-t-purple-600 mx-auto"></div>
                <p class="mt-4 text-gray-600 font-medium text-sm">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div v-else-if="images.length === 0" class="text-center py-16">
            <div class="glass rounded-xl p-8 inline-block">
                <div class="text-5xl mb-3">ğŸ”</div>
                <p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°è¡¨æƒ…åŒ…</p>
            </div>
        </div>

        <div v-else class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-4">
            <div v-for="(img, idx) in images" :key="img.hash"
                 class="emoji-card group glass rounded-xl md:rounded-2xl shadow-lg overflow-hidden border border-white/40 hover-lift hover:shadow-xl transition-all flex flex-col">
                <!-- å›¾ç‰‡åŒºåŸŸ -->
                <div class="w-full aspect-square relative cursor-zoom-in overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100"
                     @click="openPreview(img, idx)" title="ç‚¹å‡»æ”¾å¤§">
                    <img :src="img.url" :alt="img.desc"
                         class="w-full h-full object-contain p-2 md:p-3 transition-all duration-300 group-hover:scale-110"
                         loading="lazy">
                    
                    <!-- å·¦ä¸Šè§’åˆ†ç±»æ ‡ç­¾ -->
                    <div class="absolute top-2 left-2 pointer-events-none">
                        <span class="inline-flex items-center px-1.5 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs font-semibold bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg backdrop-blur-sm">
                            {{ img.category }}
                        </span>
                    </div>

                    <!-- å³ä¸Šè§’åˆ é™¤æŒ‰é’® -->
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <button @click.stop="deleteImage(img)" 
                                class="bg-white/95 hover:bg-red-50 text-red-500 rounded-full p-1.5 md:p-2 shadow-lg border border-red-100 hover:border-red-300 transition backdrop-blur-sm hover:scale-110" 
                                title="åˆ é™¤">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-1 1-1h6c1 0 1 1 1 1v2"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- åº•éƒ¨ä¿¡æ¯æ¡ -->
                <div class="p-2 md:p-3 flex-1 flex flex-col justify-between bg-white/80">
                    <p class="text-[10px] md:text-xs text-gray-700 line-clamp-2 mb-1.5 md:mb-2" :title="img.desc || 'æ— æè¿°'">
                        {{ img.desc || 'ï¼ˆæ— æè¿°ï¼‰' }}
                    </p>
                    <div class="flex flex-wrap gap-0.5 md:gap-1.5 content-end">
                        <span v-for="tag in (img.tags || []).slice(0, 2)" :key="tag"
                              class="text-[9px] md:text-[10px] bg-gradient-to-r from-purple-50 to-pink-50 text-purple-700 border border-purple-200 px-1.5 py-0.5 rounded-full font-medium">
                            #{{ tag }}
                        </span>
                        <span v-if="(img.tags || []).length > 2" class="text-[9px] md:text-[10px] text-gray-400 px-0.5">+{{ (img.tags || []).length - 2 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-2 md:gap-3 animate-fade-in-up">
            <button @click="prevPage" :disabled="currentPage === 1" 
                    class="w-full sm:w-auto px-4 py-2.5 md:px-6 md:py-3 glass border border-white/40 rounded-xl hover:bg-white/60 disabled:opacity-40 disabled:cursor-not-allowed transition shadow-md font-medium text-sm">
                â† ä¸Šä¸€é¡µ
            </button>
            <div class="glass px-4 py-2 md:px-6 md:py-3 rounded-xl text-gray-700 font-medium border border-white/40 shadow-md text-sm">
                <span class="text-purple-600 font-bold">{{ currentPage }}</span> / <span class="text-purple-600 font-bold">{{ Math.ceil(total / pageSize) }}</span>
            </div>
            <button @click="nextPage" :disabled="currentPage * pageSize >= total"
                    class="w-full sm:w-auto px-4 py-2.5 md:px-6 md:py-3 glass border border-white/40 rounded-xl hover:bg-white/60 disabled:opacity-40 disabled:cursor-not-allowed transition shadow-md font-medium text-sm">
                ä¸‹ä¸€é¡µ â†’
            </button>
        </div>

        <!-- Preview Modal -->
        <div v-if="previewOpen" class="fixed inset-0 z-50 animate-fade-in-up" role="dialog" aria-modal="true" aria-labelledby="preview-title">
            <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" @click="closePreview"></div>
            <div class="relative z-10 h-full w-full flex items-center justify-center p-2 md:p-4">
                <div class="bg-white w-full max-w-5xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden border-4 border-white/20 max-h-[95vh] flex flex-col md:flex-row">
                    <!-- Image Section -->
                    <div class="w-full md:w-auto md:flex-1 bg-gradient-to-br from-gray-50 to-gray-100 relative flex items-center justify-center p-4 md:p-6 min-h-[40vh] md:min-h-auto">
                        <img v-if="previewItem" :src="previewItem.url" :alt="previewItem.desc"
                             class="max-w-full max-h-[35vh] md:max-h-[60vh] object-contain rounded-lg shadow-lg" />
                        <button @click="prevPreview" :disabled="previewIndex <= 0"
                                class="absolute left-2 top-1/2 -translate-y-1/2 glass hover:bg-white text-gray-800 rounded-full w-10 h-10 md:w-12 md:h-12 flex items-center justify-center shadow-xl disabled:opacity-30 disabled:cursor-not-allowed border-2 border-white/40 hover:scale-110 transition">
                            <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <button @click="nextPreview" :disabled="previewIndex >= images.length - 1"
                                class="absolute right-2 top-1/2 -translate-y-1/2 glass hover:bg-white text-gray-800 rounded-full w-10 h-10 md:w-12 md:h-12 flex items-center justify-center shadow-xl disabled:opacity-30 disabled:cursor-not-allowed border-2 border-white/40 hover:scale-110 transition">
                            <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>

                    <!-- Meta Section -->
                    <div class="w-full md:w-96 flex-1 p-4 md:p-5 flex flex-col gap-4 bg-gradient-to-br from-purple-50 to-pink-50 overflow-y-auto">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs md:text-sm font-bold shadow-lg">
                                    {{ previewItem?.category || 'unknown' }}
                                </span>
                                <span class="text-xs md:text-sm text-gray-500">{{ previewIndex + 1 }} / {{ images.length }}</span>
                            </div>
                            <button @click="closePreview" class="glass hover:bg-red-50 text-gray-600 hover:text-red-600 rounded-full w-8 h-8 md:w-10 md:h-10 flex items-center justify-center transition border border-white/40 hover:border-red-200">
                                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-xl p-3 md:p-4 border border-white/60 flex-1">
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1.5">æè¿°</p>
                            <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap break-words">
                                {{ previewItem?.desc || 'ï¼ˆæ— æè¿°ï¼‰' }}
                            </p>
                        </div>

                        <div class="flex flex-wrap gap-1.5">
                            <span v-for="tag in (previewItem?.tags || [])" :key="tag"
                                  class="text-xs bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 px-2.5 py-1 rounded-full font-medium border border-purple-200">#{{ tag }}</span>
                            <span v-if="(previewItem?.tags || []).length === 0" class="text-sm text-gray-400">ï¼ˆæ— æ ‡ç­¾ï¼‰</span>
                        </div>

                        <div class="flex flex-col gap-2 mt-auto">
                            <a v-if="previewItem" :href="previewItem.url" target="_blank" rel="noreferrer"
                               class="w-full text-center px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition text-sm">
                                ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                            </a>
                            <button @click="deleteImage(previewItem)" 
                                    class="w-full px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition text-sm">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div v-if="uploadOpen" class="fixed inset-0 z-50 animate-fade-in-up" role="dialog" aria-modal="true" aria-labelledby="upload-title">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeUploadModal"></div>
            <div class="relative z-10 h-full w-full flex items-center justify-center p-3 md:p-4">
                <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border-4 border-white/20 max-h-[95vh] overflow-y-auto">
                    <div class="p-4 md:p-6 bg-gradient-to-r from-green-500 to-emerald-600">
                        <div class="flex items-center justify-between">
                            <h2 id="upload-title" class="text-xl md:text-2xl font-bold text-white">æ·»åŠ è¡¨æƒ…åŒ…</h2>
                            <button @click="closeUploadModal" class="glass hover:bg-white/30 text-white rounded-full w-8 h-8 md:w-10 md:h-10 flex items-center justify-center transition border border-white/40">
                                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <form @submit.prevent="submitUpload" class="p-4 md:p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å›¾ç‰‡</label>
                            <div class="relative border-2 border-dashed border-purple-200 rounded-xl p-4 md:p-6 text-center hover:border-purple-400 transition bg-purple-50/50" 
                                 @dragover.prevent @drop.prevent="handleDrop">
                                <input type="file" accept="image/*" @change="handleFileSelect" required
                                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <div v-if="uploadFile" class="flex items-center justify-center gap-3 md:gap-4">
                                    <img :src="uploadPreviewUrl" class="w-16 h-16 md:w-20 md:h-20 object-contain rounded-lg shadow">
                                    <div class="text-left">
                                        <p class="font-medium text-gray-800 text-sm md:text-base">{{ uploadFile.name }}</p>
                                        <p class="text-xs md:text-sm text-gray-500">{{ (uploadFile.size / 1024).toFixed(1) }} KB</p>
                                    </div>
                                </div>
                                <div v-else class="text-purple-500">
                                    <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                    <p class="font-medium text-sm md:text-base">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </p>
                                    <p class="text-xs text-gray-400 mt-1">æ”¯æŒ PNGã€JPGã€GIFã€WebP</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                è¡¨æƒ…åˆ†ç±»
                                <span class="text-gray-400 font-normal text-xs">(æƒ…ç»ªå¤§ç±»)</span>
                            </label>
                            <select v-model="uploadForm.emotion"
                                    class="w-full px-3 py-2.5 md:px-4 md:py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none bg-white/80 cursor-pointer transition text-sm">
                                <option value="">é€‰æ‹©æƒ…ç»ª...</option>
                                <option v-for="emo in availableEmotions" :key="emo.key" :value="emo.key" :title="emo.desc">
                                    {{ emo.name }} ({{ emo.key }})
                                </option>
                            </select>
                            <p v-if="uploadForm.emotion" class="text-xs text-gray-500 mt-1">
                                {{ getEmotionDesc(uploadForm.emotion) }}
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                è¯­ä¹‰æ ‡ç­¾
                                <span class="text-gray-400 font-normal text-xs">(é€—å·åˆ†éš”)</span>
                            </label>
                            <input type="text" v-model="uploadForm.tags"
                                   placeholder="å¦‚: å¤§ç¬‘, ç†ŠçŒ«äºº"
                                   class="w-full px-3 py-2.5 md:px-4 md:py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç®€å•æè¿°</label>
                            <textarea v-model="uploadForm.desc" rows="2"
                                      placeholder="æè¿°å›¾ç‰‡å†…å®¹"
                                      class="w-full px-3 py-2.5 md:px-4 md:py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none text-sm"></textarea>
                        </div>

                        <div v-if="uploadError" class="p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
                            {{ uploadError }}
                        </div>

                        <div class="flex gap-2 md:gap-3 pt-2">
                            <button type="button" @click="closeUploadModal"
                                    class="flex-1 px-4 py-2.5 md:px-5 md:py-3 glass border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition font-medium text-sm">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" :disabled="uploading || !uploadFile"
                                    class="flex-1 px-4 py-2.5 md:px-5 md:py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg font-medium text-sm">
                                <span v-if="uploading">ä¸Šä¼ ä¸­...</span>
                                <span v-else>âœ… ç¡®è®¤æ·»åŠ </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Emotions Modal -->
        <div v-if="emotionsOpen" class="fixed inset-0 z-50 animate-fade-in-up" role="dialog" aria-modal="true" aria-labelledby="emotions-title">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeEmotionsModal"></div>
            <div class="relative z-10 h-full w-full flex items-center justify-center p-3 md:p-4">
                <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden border-4 border-white/20 max-h-[95vh] overflow-y-auto">
                    <div class="p-4 md:p-6 bg-gradient-to-r from-blue-500 to-indigo-600">
                        <div class="flex items-center justify-between">
                            <h2 id="emotions-title" class="text-xl md:text-2xl font-bold text-white">ç®¡ç†æƒ…ç»ªåˆ†ç±»</h2>
                            <button @click="closeEmotionsModal" class="glass hover:bg-white/30 text-white rounded-full w-8 h-8 md:w-10 md:h-10 flex items-center justify-center transition border border-white/40">
                                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 md:p-6">
                        <p class="text-gray-600 mb-3 text-sm">ç¼–è¾‘å¯ç”¨çš„æƒ…ç»ªåˆ†ç±»ã€‚</p>
                        
                        <div class="space-y-2 max-h-60 md:max-h-80 overflow-y-auto mb-4">
                            <div v-for="(emotion, index) in emotions" :key="emotion.key" 
                                 class="flex flex-wrap md:flex-nowrap items-center gap-2 p-2 md:p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <span class="w-6 h-6 md:w-8 md:h-8 bg-gradient-to-br from-purple-400 to-pink-500 rounded-lg flex items-center justify-center text-white text-xs md:text-sm order-1">
                                    {{ index + 1 }}
                                </span>
                                <input type="text" v-model="emotion.key" 
                                       class="flex-1 px-2 py-1.5 md:px-3 md:py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-xs md:text-sm order-2"
                                       title="å”¯ä¸€æ ‡è¯†ç¬¦">
                                <input type="text" v-model="emotion.name" 
                                       class="flex-1 px-2 py-1.5 md:px-3 md:py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs md:text-sm order-3"
                                       placeholder="åç§°">
                                <input type="text" v-model="emotion.desc" 
                                       class="w-full md:flex-[2] px-2 py-1.5 md:px-3 md:py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs md:text-sm order-4"
                                       placeholder="æè¿°">
                                <button @click="removeEmotion(index)" 
                                        class="p-1.5 md:p-2 text-red-500 hover:bg-red-50 rounded-lg transition order-5 ml-auto md:ml-0">
                                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="p-3 md:p-4 bg-blue-50 rounded-xl border border-blue-200 mb-4">
                            <p class="text-xs md:text-sm text-blue-700 mb-2">æ·»åŠ æ–°çš„æƒ…ç»ªåˆ†ç±»ï¼š</p>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" v-model="newEmotionKey" placeholder="key" 
                                       class="flex-1 min-w-[80px] px-2 py-1.5 md:px-3 md:py-2 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-xs md:text-sm">
                                <input type="text" v-model="newEmotionName" placeholder="åç§°" 
                                       class="flex-1 min-w-[60px] px-2 py-1.5 md:px-3 md:py-2 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs md:text-sm">
                                <input type="text" v-model="newEmotionDesc" placeholder="æè¿°" 
                                       class="flex-[2] min-w-[100px] px-2 py-1.5 md:px-3 md:py-2 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs md:text-sm">
                                <button @click="addEmotion" 
                                        class="px-3 py-1.5 md:px-4 md:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-xs md:text-sm whitespace-nowrap">
                                    â• æ·»åŠ 
                                </button>
                            </div>
                        </div>

                        <div v-if="emotionsError" class="p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm mb-4">
                            {{ emotionsError }}
                        </div>

                        <div class="flex gap-2 md:gap-3 pt-2">
                            <button type="button" @click="closeEmotionsModal"
                                    class="flex-1 px-4 py-2.5 md:px-5 md:py-3 glass border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition font-medium text-sm">
                                å–æ¶ˆ
                            </button>
                            <button @click="saveEmotions" :disabled="savingEmotions"
                                    class="flex-1 px-4 py-2.5 md:px-5 md:py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 disabled:opacity-50 transition shadow-lg font-medium text-sm">
                                <span v-if="savingEmotions">ä¿å­˜ä¸­...</span>
                                <span v-else>ğŸ’¾ ä¿å­˜è®¾ç½®</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    images: [],
                    stats: { total_images: 0, categories: {} },
                    loading: false,
                    searchQuery: '',
                    selectedCategory: '',
                    currentPage: 1,
                    pageSize: 24,
                    total: 0,
                    searchTimeout: null,

                    previewOpen: false,
                    previewItem: null,
                    previewIndex: -1,

                    uploadOpen: false,
                    uploading: false,
                    uploadFile: null,
                    uploadPreviewUrl: null,
                    uploadError: null,
                    uploadForm: {
                        emotion: '',
                        tags: '',
                        desc: ''
                    },

                    emotionsOpen: false,
                    emotions: [],
                    savingEmotions: false,
                    emotionsError: null,
                    newEmotionKey: '',
                    newEmotionName: '',
                    newEmotionDesc: '',
                    availableEmotions: []
                }
            },
            mounted() {
                this.fetchStats();
                this.fetchImages();
                this.fetchEmotions();

                // é”®ç›˜å¿«æ·é”®ï¼ˆé¢„è§ˆæ›´é¡ºæ‰‹ï¼‰
                window.addEventListener('keydown', this.onKeydown);
            },
            unmounted() {
                window.removeEventListener('keydown', this.onKeydown);
            },
            methods: {
                openPreview(img, idx) {
                    this.previewItem = img;
                    this.previewIndex = idx;
                    this.previewOpen = true;
                },
                closePreview() {
                    this.previewOpen = false;
                    this.previewItem = null;
                    this.previewIndex = -1;
                },
                prevPreview() {
                    if (this.previewIndex > 0) {
                        const idx = this.previewIndex - 1;
                        this.openPreview(this.images[idx], idx);
                    }
                },
                nextPreview() {
                    if (this.previewIndex < this.images.length - 1) {
                        const idx = this.previewIndex + 1;
                        this.openPreview(this.images[idx], idx);
                    }
                },
                onKeydown(e) {
                    if (!this.previewOpen) return;
                    if (e.key === 'Escape') {
                        this.closePreview();
                    } else if (e.key === 'ArrowLeft') {
                        this.prevPreview();
                    } else if (e.key === 'ArrowRight') {
                        this.nextPreview();
                    }
                },
                async fetchStats() {
                    try {
                        const res = await fetch('/api/stats');
                        this.stats = await res.json();
                    } catch (e) {
                        console.error(e);
                    }
                },
                async fetchImages(page = this.currentPage) {
                    this.loading = true;
                    this.currentPage = page;
                    try {
                        const params = new URLSearchParams({
                            page: page,
                            size: this.pageSize,
                            q: this.searchQuery,
                        });
                        if (this.selectedCategory) {
                            params.append('category', this.selectedCategory);
                        }
                        
                        const res = await fetch(`/api/images?${params}`);
                        const data = await res.json();
                        this.images = data.images;
                        this.total = data.total;

                        // è‹¥é¢„è§ˆæ‰“å¼€ï¼Œåˆ·æ–°åå°½é‡ä¿æŒå½“å‰é¢„è§ˆé¡¹
                        if (this.previewOpen && this.previewItem) {
                            const idx = this.images.findIndex(x => x.hash === this.previewItem.hash);
                            if (idx >= 0) {
                                this.openPreview(this.images[idx], idx);
                            } else {
                                this.closePreview();
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        alert('åŠ è½½å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                debouncedSearch() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.fetchImages(1);
                    }, 500);
                },
                async deleteImage(img) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ è¡¨æƒ…åŒ…å—ï¼Ÿ')) return;
                    
                    try {
                        const res = await fetch(`/api/images/${img.hash}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            if (this.previewOpen && this.previewItem && this.previewItem.hash === img.hash) {
                                this.closePreview();
                            }
                            this.fetchImages(this.currentPage);
                            this.fetchStats();
                        } else {
                            alert('åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('åˆ é™¤å‡ºé”™');
                    }
                },
                prevPage() {
                    if (this.currentPage > 1) {
                        this.fetchImages(this.currentPage - 1);
                    }
                },
                nextPage() {
                    if (this.currentPage * this.pageSize < this.total) {
                        this.fetchImages(this.currentPage + 1);
                    }
                },
                openUploadModal() {
                    this.uploadOpen = true;
                    this.uploadError = null;
                    this.uploadFile = null;
                    this.uploadPreviewUrl = null;
                    this.uploadForm = { emotion: '', tags: '', desc: '' };
                },
                closeUploadModal() {
                    this.uploadOpen = false;
                    this.uploadFile = null;
                    this.uploadPreviewUrl = null;
                    this.uploadError = null;
                },
                handleFileSelect(e) {
                    const file = e.target.files[0];
                    this.setUploadFile(file);
                },
                handleDrop(e) {
                    const file = e.dataTransfer.files[0];
                    this.setUploadFile(file);
                },
                setUploadFile(file) {
                    if (!file || !file.type.startsWith('image/')) {
                        this.uploadError = 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶';
                        return;
                    }
                    this.uploadFile = file;
                    this.uploadError = null;
                    this.uploadPreviewUrl = URL.createObjectURL(file);
                },
                async submitUpload() {
                    if (!this.uploadFile) return;
                    
                    this.uploading = true;
                    this.uploadError = null;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.uploadFile);
                        formData.append('emotion', this.uploadForm.emotion);
                        formData.append('tags', this.uploadForm.tags);
                        formData.append('desc', this.uploadForm.desc);
                        
                        const res = await fetch('/api/images/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await res.json();
                        
                        if (data.success) {
                            this.closeUploadModal();
                            this.fetchImages(1);
                            this.fetchStats();
                            this.$nextTick(() => {
                                this.openPreview({ hash: data.image.hash, url: data.image.url }, 0);
                            });
                        } else {
                            this.uploadError = data.error || 'ä¸Šä¼ å¤±è´¥';
                        }
                    } catch (e) {
                        console.error(e);
                        this.uploadError = 'ä¸Šä¼ å‡ºé”™ï¼Œè¯·é‡è¯•';
                    } finally {
                        this.uploading = false;
                    }
                },
                async fetchEmotions() {
                    try {
                        const res = await fetch('/api/emotions');
                        const data = await res.json();
                        this.availableEmotions = data.emotions || [];
                    } catch (e) {
                        console.error(e);
                    }
                },
                getEmotionDesc(key) {
                    const emotion = this.availableEmotions.find(e => e.key === key);
                    return emotion ? emotion.desc || 'æš‚æ— æè¿°' : '';
                },
                async openEmotionsModal() {
                    this.emotionsOpen = true;
                    this.emotionsError = null;
                    this.newEmotionKey = '';
                    this.newEmotionName = '';
                    try {
                        const res = await fetch('/api/emotions');
                        const data = await res.json();
                        this.emotions = data.emotions || [];
                    } catch (e) {
                        console.error(e);
                        this.emotionsError = 'åŠ è½½å¤±è´¥';
                    }
                },
                closeEmotionsModal() {
                    this.emotionsOpen = false;
                    this.emotions = [];
                    this.emotionsError = null;
                    this.newEmotionKey = '';
                    this.newEmotionName = '';
                    this.newEmotionDesc = '';
                },
                addEmotion() {
                    const key = this.newEmotionKey.trim();
                    const name = this.newEmotionName.trim();
                    const desc = this.newEmotionDesc.trim();
                    
                    if (!key || !name) {
                        this.emotionsError = 'è¯·å¡«å†™ key å’Œåç§°';
                        return;
                    }
                    
                    if (this.emotions.some(e => e.key === key)) {
                        this.emotionsError = 'key å·²å­˜åœ¨';
                        return;
                    }
                    
                    this.emotions.push({ key, name, desc });
                    this.newEmotionKey = '';
                    this.newEmotionName = '';
                    this.newEmotionDesc = '';
                    this.emotionsError = null;
                },
                removeEmotion(index) {
                    this.emotions.splice(index, 1);
                },
                async saveEmotions() {
                    if (this.emotions.length === 0) {
                        this.emotionsError = 'è‡³å°‘ä¿ç•™ä¸€ä¸ªåˆ†ç±»';
                        return;
                    }
                    
                    this.savingEmotions = true;
                    this.emotionsError = null;
                    
                    try {
                        // å‘é€å®Œæ•´å¯¹è±¡æ•°ç»„ï¼ŒåŒ…å« keyã€nameã€desc
                        const categories = this.emotions.map(e => ({
                            key: e.key,
                            name: e.name,
                            desc: e.desc
                        }));
                        const res = await fetch('/api/categories', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ categories })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            this.closeEmotionsModal();
                            this.fetchImages(1);
                            this.fetchStats();
                        } else {
                            this.emotionsError = data.error || 'ä¿å­˜å¤±è´¥';
                        }
                    } catch (e) {
                        console.error(e);
                        this.emotionsError = 'ä¿å­˜å‡ºé”™ï¼Œè¯·é‡è¯•';
                    } finally {
                        this.savingEmotions = false;
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
